name: Mirror Brave Browser Releases

on:
  schedule:
    - cron: '0 */6 * * *' # Runs every 6 hours
  workflow_dispatch: # Allows manual triggering

jobs:
  mirror:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to create/delete releases
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch Latest Brave Release Info
        id: brave_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the latest release tag from the official Brave repo
          LATEST_TAG=$(gh release view --repo brave/brave-browser --json tagName --template '{{.tagName}}')
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV
          
          # Check if this tag already exists in YOUR repo
          EXISTS=$(gh release view $LATEST_TAG >/dev/null 2>&1 && echo "true" || echo "false")
          echo "EXISTS=$EXISTS" >> $GITHUB_ENV

      - name: Mirror Release
        if: env.EXISTS == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "New version found: ${{ env.LATEST_TAG }}. Mirroring..."
          
          # 1. Download only .dmg assets from Brave
          gh release download ${{ env.LATEST_TAG }} \
            --repo brave/brave-browser \
            --pattern "*.dmg" \
            --dir ./downloads

          # 2. Create the release in your repo
          gh release create ${{ env.LATEST_TAG }} \
            ./downloads/*.dmg \
            --title "Brave Browser ${{ env.LATEST_TAG }}" \
            --notes "Automated mirror of Brave Browser macOS release ${{ env.LATEST_TAG }}."

      - name: Cleanup Old Releases (Keep N-1)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Cleaning up old releases, keeping only the 2 most recent..."
          
          # List all releases, skip the first 2 (n and n-1), and delete the rest
          RELEASES_TO_DELETE=$(gh release list --limit 100 | tail -n +3 | awk '{print $1}')
          
          for TAG in $RELEASES_TO_DELETE; do
            echo "Deleting old release: $TAG"
            gh release delete $TAG --yes --cleanup-tag
          done
